<!-- Generated by SpecStory -->

# 次のプランについて (2025-05-09 01:16:49)

_**User**_

次のプラン

---

_**Assistant**_



---

<details>
            <summary>Listed directory  • **19** results</summary>
        
| Name |
|-------|
| 📁 `.git` |
| 📄 `.gitignore` |
| 📁 `.elixir_ls` |
| 📁 `.vscode` |
| 📄 `erl_crash.dump` |
| 📄 `.cursorindexingignore` |
| 📁 `.specstory` |
| 📁 `_build` |
| 📁 `test` |
| 📄 `.credo.exs` |
| 📄 `mix.lock` |
| 📁 `deps` |
| 📄 `mix.exs` |
| 📁 `assets` |
| 📁 `priv` |
| 📄 `.formatter.exs` |
| 📄 `README.md` |
| 📁 `lib` |
| 📁 `config` |

</details>

---



---

Read file: mix.exs

---



---

<details>
            <summary>Listed directory lib • **4** results</summary>
        
| Name |
|-------|
| 📄 `crud_web.ex` |
| 📁 `crud` |
| 📁 `crud_web` |
| 📄 `crud.ex` |

</details>

---



---

<details>
            <summary>Listed directory lib/crud • **5** results</summary>
        
| Name |
|-------|
| 📄 `blog.ex` |
| 📁 `blog` |
| 📄 `mailer.ex` |
| 📄 `repo.ex` |
| 📄 `application.ex` |

</details>

---



---

Read file: lib/crud/blog.ex

---



---

Read file: lib/crud/blog/post.ex

---



---

<details>
            <summary>Listed directory lib/crud_web • **6** results</summary>
        
| Name |
|-------|
| 📄 `router.ex` |
| 📁 `controllers` |
| 📁 `components` |
| 📄 `gettext.ex` |
| 📄 `endpoint.ex` |
| 📄 `telemetry.ex` |

</details>

---



---

<details>
            <summary>Listed directory lib/crud_web/controllers • **8** results</summary>
        
| Name |
|-------|
| 📄 `post_controller.ex` |
| 📄 `error_html.ex` |
| 📄 `page_controller.ex` |
| 📄 `post_html.ex` |
| 📁 `post_html` |
| 📁 `page_html` |
| 📄 `page_html.ex` |
| 📄 `error_json.ex` |

</details>

---



---

Read file: lib/crud_web/controllers/post_controller.ex

---



---

Read file: lib/crud_web/router.ex

---



---

<details>
            <summary>Listed directory lib/crud_web/components • **3** results</summary>
        
| Name |
|-------|
| 📄 `core_components.ex` |
| 📁 `layouts` |
| 📄 `layouts.ex` |

</details>

---



---

<details>
            <summary>Grep search for "Comment" • **2** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///home/diverge/elixir/CRUD/lib/crud_web/controllers/error_html.ex` | L9 | `# uncomment the embed_templates/1 call below` |
| `file:///home/diverge/elixir/CRUD/lib/crud_web/controllers/error_html.ex` | L9 | `# uncomment the embed_templates/1 call below` |

</details>

---



---

🗂️ 次の開発フェーズに進むための「ステップ別プラン」を提案します。いずれも段階的に実施でき、途中で優先順位を入れ替えても構いません。

────────────────────
1. テスト／品質フェーズ
────────────────────
• ExUnit を用いた単体テストの追加  
  – `Crud.Blog` コンテキストの happy/edge case を網羅  
  – `CrudWeb.PostController` のコントローラテストを追加（`conn_case`）  
• Credo ＆ Dialyzer を CI で自動実行  
• GitHub Actions（あるいは GitLab CI）で `mix test`, `mix credo --strict`, `mix dialyzer` を流すワークフローを用意

────────────────────
2. UI 改善／LiveView 置き換え
────────────────────
• Post 一覧／詳細／編集フォームを Phoenix LiveView 化  
• コンポーネント化された入力フォーム（Tailwind + `core_components.ex`）を再利用  
• リアルタイムバリデーション、flash なしの更新・削除を実装  

────────────────────
3. 認証機能の導入
────────────────────
• `mix phx.gen.auth Accounts User users` でユーザ登録／セッション管理を生成  
• Post との関連（`belongs_to :user`）を追加し、権限で CRUD を制御  
• LiveView のセッションフック・`on_mount` で認可を実装

────────────────────
4. コメント機能（新リソース）
────────────────────
• `mix phx.gen.html Blog Comment comments body:text post_id:references:posts`  
• Post ↔︎ Comment の `has_many/ belongs_to` 関連付け  
• LiveComponent でコメントをインライン追加／削除  
• N+1 を防ぐため `Repo.preload/2` と `Ecto.Multi` でまとめて取得・保存  

────────────────────
5. 運用・デプロイ
────────────────────
• Dockerfile と docker-compose.yml（Phoenix + PostgreSQL）  
• `MIX_ENV=prod mix release` でイメージ作成  
• Fly.io / Railway / Render などへワンコマンドデプロイ  
• LiveDashboard を本番環境で見る場合は BasicAuth を設定  

────────────────────
6. 付加価値機能（必要に応じて）
────────────────────
• 検索（PostgreSQL の full-text search or trigram）  
• ページネーション（Scrivener）  
• タグ機能（Many-to-Many）  
• API エンドポイント（`resources "/api/posts", Api.PostController, except: [:new, :edit]`）  
• OpenAPI ドキュメント自動生成（PhoenixSwagger など）

この順番で進めれば、品質 → UI/UX → セキュリティ → 新機能 → デプロイという流れで、少しずつ本番運用に耐えるアプリへ育てられます。まずは 1 のテスト基盤を整えてから、LiveView 化へ着手することをおすすめします。

---

_**User**_

社内日次報告・週次報告・月次報告アプリにしたいので、先のプランに追記。月曜日から金曜日の日次報告から自動で要点を抽出して週報を作成、日次・週次報告から自動で要点を抽出して月次報告を作成する機能、報告内容はマークダウンで編集

---

_**Assistant**_



---

🗂️ 先ほどのロードマップに「日次／週次／月次報告アプリ化」の項目を追加した最新版プランを提示します。追加部分のみ強調するため、各フェーズの後半に追記する形で示します。

────────────────────
1. テスト／品質フェーズ（変更なし）
────────────────────
• ExUnit テスト、CI、Credo/Dialyzer … (前述)

────────────────────
2. UI 改善／LiveView 置き換え ※追記あり
────────────────────
• Post を “Report”（報告）リソースへリネーム（Migrate & LiveView 化）  
• Markdown エディタ＋プレビュー  
  – `Phoenix.Component` で `<MarkdownEditor/>` を実装  
  – JS は `ToastUI Editor` や `SimpleMDE` を import  

────────────────────
3. 認証機能の導入（変更なし）
────────────────────

────────────────────
4. コメント機能 → 報告階層&要約機能へ置き換え
────────────────────
• モデル設計  
  – reports テーブル  
    • id, type(enum: :daily | :weekly | :monthly), user_id, date, body_md, summary_md, inserted_at …  
  – `has_many :reports, Crud.Accounts.User`  
• 日次報告はユーザが手入力（Markdown）  
• 自動要約ジョブ  
  – 背景ジョブフレームワーク: `Oban`  
  – 金曜 23:59:59 に「その週の :daily」を集約 → :weekly を生成  
  – 月末 23:59:59 に「その月の :daily + :weekly」を集約 → :monthly を生成  
• 要約アルゴリズム  
  – オプション1: ChatGPT / OpenAI API（`ex_openai`）  
  – オプション2: 文章抽出ライブラリ（`Bunt`, `Natural`, もしくは自前 TextRank 実装）  
  – 権限設定で自動投稿された weekly/monthly を編集可  
• UI  
  – サイドバーで期間フィルタ（日／週／月）  
  – 日次画面: `reports/live/daily_index.ex` & `.heex`  
  – 週報／月報画面: 自動で生成された Markdown を確認・修正し保存  

────────────────────
5. 運用・デプロイ（追記あり）
────────────────────
• 環境変数に OpenAI API KEY 等のシークレット  
• Oban のダッシュボードを LiveDashboard に統合し、ジョブ状態を監視  

────────────────────
6. 付加価値機能（追記あり）
────────────────────
• Slack / Teams 通知: 週報・月報生成完了時に URL を送信  
• PDF 生成（`ChromicPDF`）して役員提出用にエクスポート  
• レポート検索・ハイライト（`Postgrex` + trigram）  

このアップデートにより、「Markdown で編集できる日次報告」と「AI/アルゴリズムによる自動要約で週報・月報が生成される」要件を包含したプランになります。

---

_**User**_

自動要約機能はオン・オフを切り替えられるようにしたい

---

_**Assistant**_



---

🔧 要望を反映し、「自動要約をオン／オフできる仕組み」をロードマップへ追記しました。

────────────────────
4. 報告階層 & 要約機能（更新）
────────────────────
• モデル設計  
  – reports テーブル（前述）  
  – users テーブルに `auto_summarize?:boolean` を追加  
    • 既定値 `true`（マイグレーションで設定）  
    • ユーザ設定画面でトグル可能（LiveView でスイッチ UI）  

• 自動要約ジョブ（Oban）  
  – ジョブ起動前に `user.auto_summarize?` を確認  
  – オフのユーザはスキップ、オンの場合だけ :weekly / :monthly を生成  
  – 管理者向けに強制再集約タスク `mix reports.summarize --force` を用意  

• UI  
  – 設定ページ `/settings`  
    • 「自動要約を有効にする」トグル（`Phoenix.Component.checkbox` + LiveView）  
  – 週報・月報画面で「このレポートは自動生成です」リボンを表示  
    • トグルがオフなら手動用テンプレートを表示し、ユーザ入力を促す  

• Config フォールバック  
  – 環境全体で無効化したい場合 `config/runtime.exs` に  
    `config :crud, auto_summarize_global?: false`  
  – ジョブ側で `Application.get_env/3` をチェックし、ユーザ設定より優先  

これにより、  
1) 個人単位でオン／オフできる  
2) 環境変数や設定ファイルで全社的に無効化も可能  
という二段構えの切り替えが実現できます。

---

_**User**_

ここまでのプランをまとめて

---

_**Assistant**_



---

📒 社内「日次・週次・月次報告アプリ」への移行計画（総まとめ）

STEP 1. 品質基盤
• ExUnit でコンテキスト／コントローラテストを充実  
• Credo・Dialyzer を CI で強制  
• GitHub Actions 等で `mix test`, `mix credo --strict`, `mix dialyzer` 連携  

STEP 2. UI & LiveView
• Post → Report へ名称変更し LiveView 化  
• Tailwind + `<MarkdownEditor/>`（ToastUI / SimpleMDE）で WYSIWYG／プレビュー  
• core_components を再利用しつつページネーション・フィルタ実装  

STEP 3. 認証
• `mix phx.gen.auth` でユーザ管理を導入  
• Report に `belongs_to :user`、認可を on_mount でチェック  

STEP 4. 報告階層 & 自動要約
• reports テーブル  
  – type: :daily / :weekly / :monthly  
  – body_md, summary_md, date, user_id など  
• users テーブルに `auto_summarize?: boolean`（初期 true）  
• Oban ジョブ  
  – 金曜深夜: daily → weekly  
  – 月末: daily + weekly → monthly  
  – ジョブ前にユーザの `auto_summarize?` と `config :crud, auto_summarize_global?` を確認  
• 要約ロジック  
  – OpenAI API もしくは TextRank 等  
• UI  
  – 設定ページで自動要約トグル  
  – 自動生成レポートには「Auto」リボン、オフ時は手入力テンプレート  

STEP 5. 運用・デプロイ
• Dockerfile／docker-compose で Phoenix + PostgreSQL  
• `mix release` + Fly.io / Render などへデプロイ  
• Oban & LiveDashboard 連携、OpenAI KEY を環境変数管理  

STEP 6. 付加価値
• Slack / Teams 通知（週報・月報生成完了）  
• PDF エクスポート（ChromicPDF）  
• 高速全文検索（PG trigram）  
• REST / OpenAPI エンドポイント公開  

これで「Markdown で日次報告を記入 → AI が週報・月報を生成（任意でオフ可）」という要件を網羅したロードマップが完成です。

---

